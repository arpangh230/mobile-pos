<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Mobile POS - Full Accounting System</title>
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs (Exactly like index1.html) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

    <style>
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --dark: #0f172a; --bg: #f1f5f9;
        }
        body { font-family: 'Noto Sans Bengali', sans-serif; background-color: var(--bg); padding-bottom: 90px; overflow-x: hidden; }
        
        /* Smooth Bottom Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff;
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1); z-index: 1050;
            border-top-left-radius: 25px; border-top-right-radius: 25px;
        }
        .nav-item { text-align: center; color: #64748b; text-decoration: none; font-size: 10px; flex: 1; transition: 0.3s ease; }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 3px; }
        .nav-item.active { color: var(--primary); font-weight: bold; transform: translateY(-3px); }

        /* Modern UI Cards */
        .app-section { display: none; padding: 15px; animation: slideUp 0.4s ease; }
        .app-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { border: none; border-radius: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; background: #fff; overflow: hidden; }
        .stat-card { padding: 20px 15px; text-align: center; position: relative; }
        .stat-card h4 { font-size: 18px; font-weight: 700; margin: 5px 0; color: var(--dark); }
        .stat-card small { color: #64748b; font-size: 12px; font-weight: 500; }

        /* POS Search & Suggestions */
        .search-area { position: sticky; top: 0; z-index: 100; background: var(--bg); padding: 10px 0; }
        .suggestion-box { position: absolute; width: 100%; background: white; z-index: 1100; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; border-radius: 12px; margin-top: 5px; }
        .suggestion-item { padding: 12px 18px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-item:active { background: #f8fafc; }

        /* POS Cart */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 12px; margin-bottom: 8px; }
        .qty-controls { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; background: #fff; display: flex; align-items: center; justify-content: center; }

        /* Tables & Lists */
        .list-row { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        .print-only { display: none; }
    </style>
</head>
<body>

    <!-- Loader Screen -->
    <div id="loader">
        <div class="spinner-grow text-primary mb-3"></div>
        <h6 class="fw-bold text-primary">ডাটাবেস কানেক্ট হচ্ছে...</h6>
        <p class="small text-muted">অনুগ্রহ করে কিছুক্ষণ অপেক্ষা করুন</p>
    </div>

    <!-- Header -->
    <div class="bg-primary text-white p-3 sticky-top d-flex justify-content-between align-items-center shadow">
        <h5 class="m-0 fw-bold"><i class="fa fa-bolt me-2 text-warning"></i>AGC Mobile POS</h5>
        <div class="d-flex align-items-center">
            <span id="sync-indicator" class="badge bg-light text-primary me-2"><i class="fa fa-sync fa-spin"></i> Syncing</span>
            <i class="fa fa-user-circle fs-3" onclick="showSec('settings')"></i>
        </div>
    </div>

    <!-- Main Content Sections -->
    <div id="content-area">
        
        <!-- 1. DASHBOARD -->
        <section id="dashboard" class="app-section active">
            <div class="row g-2 mb-3">
                <div class="col-6"><div class="card stat-card"><small>আজকের বিক্রি</small><h4 id="dash-today-sale">৳ ০</h4></div></div>
                <div class="col-6"><div class="card stat-card" style="border-bottom: 4px solid var(--danger);"><small>মোট বকেয়া</small><h4 id="dash-total-due">৳ ০</h4></div></div>
                <div class="col-6"><div class="card stat-card" style="border-bottom: 4px solid var(--success);"><small>ক্যাশ ব্যালেন্স</small><h4 id="dash-cash-bal">৳ ০</h4></div></div>
                <div class="col-6"><div class="card stat-card" style="border-bottom: 4px solid #6366f1;"><small>ব্যাংক ব্যালেন্স</small><h4 id="dash-bank-bal">৳ ০</h4></div></div>
            </div>

            <!-- Forecast Insight -->
            <div class="card p-3 border-0 shadow-sm mb-3" style="background: linear-gradient(135deg, #2563eb, #1e40af); color: white;">
                <h6 class="small fw-bold opacity-75"><i class="fa fa-lightbulb me-1"></i> বিক্রয় পূর্বাভাস</h6>
                <div class="d-flex justify-content-between align-items-end mt-2">
                    <div>
                        <h4 class="m-0" id="forecast-sale">৳ ০</h4>
                        <small class="opacity-75">আগামী মাসের সম্ভাব্য বিক্রি</small>
                    </div>
                    <i class="fa fa-chart-line fs-1 opacity-25"></i>
                </div>
            </div>

            <!-- Low Stock Alerts -->
            <div id="low-stock-container"></div>
        </section>

        <!-- 2. POS (Fully Optimized) -->
        <section id="pos" class="app-section">
            <div class="search-area">
                <div class="position-relative">
                    <input type="text" id="pos-search" class="form-control py-2 shadow-sm rounded-pill" placeholder="প্রোডাক্ট নাম বা ID লিখুন...">
                    <div id="pos-prod-sug" class="suggestion-box" style="display:none;"></div>
                </div>
            </div>

            <div class="card p-3 mb-3 border-0 shadow-sm">
                <div id="cart-items" style="min-height: 100px;">
                    <p class="text-center text-muted small my-4">কার্ট খালি আছে। প্রোডাক্ট যোগ করুন।</p>
                </div>
                <div class="d-flex justify-content-between fw-bold pt-3 border-top mt-2">
                    <span>মোট বিল:</span> <h5 id="cart-grand-total" class="text-primary fw-bold">৳ ০</h5>
                </div>
            </div>

            <div class="card p-3 border-0 shadow-sm">
                <h6 class="fw-bold small text-muted border-bottom pb-2 mb-3">কাস্টমার ও পেমেন্ট</h6>
                <div class="position-relative mb-2">
                    <input type="text" id="pos-cust-name" class="form-control" placeholder="কাস্টমার নাম">
                    <div id="pos-cust-sug" class="suggestion-box" style="display:none;"></div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="text" id="pos-cust-phone" class="form-control" placeholder="ফোন"></div>
                    <div class="col-6"><input type="text" id="pos-cust-addr" class="form-control" placeholder="ঠিকানা"></div>
                </div>

                <label class="small fw-bold mb-1">পেমেন্ট মেথড</label>
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <input type="radio" class="btn-check" name="payType" id="p-due" value="due" checked onchange="handleBankSelect()">
                        <label class="btn btn-outline-danger w-100 btn-sm" for="p-due">বাকি</label>
                    </div>
                    <div class="col-4">
                        <input type="radio" class="btn-check" name="payType" id="p-cash" value="cash" onchange="handleBankSelect()">
                        <label class="btn btn-outline-success w-100 btn-sm" for="p-cash">নগদ</label>
                    </div>
                    <div class="col-4">
                        <input type="radio" class="btn-check" name="payType" id="p-bank" value="bank" onchange="handleBankSelect()">
                        <label class="btn btn-outline-primary w-100 btn-sm" for="p-bank">ব্যাংক</label>
                    </div>
                </div>

                <div id="bank-list-area" style="display:none;" class="mb-3">
                    <select id="pos-bank-select" class="form-select"></select>
                </div>

                <button class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow" onclick="completeSale()">বিক্রয় সম্পন্ন করুন</button>
            </div>
        </section>

        <!-- 3. SALES REPORT & DELETE -->
        <section id="sales" class="app-section">
            <div class="card p-2 mb-3 shadow-sm">
                <input type="date" id="sale-date" class="form-control border-0" onchange="loadSalesReport()">
            </div>
            <div id="sales-report-list"></div>
        </section>

        <!-- 4. CUSTOMERS & DUE EDIT -->
        <section id="customers" class="app-section">
            <div class="card p-2 mb-3 shadow-sm">
                <input type="text" id="cust-search-input" class="form-control border-0" placeholder="কাস্টমার খুঁজুন..." oninput="renderCustomers(this.value)">
            </div>
            <div id="customer-list-ui"></div>
        </section>

        <!-- 5. LEDGER (CASH & BANK) -->
        <section id="ledger" class="app-section">
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-sm btn-outline-primary active w-100 rounded-pill" id="btn-c-gl" onclick="renderGL('cash')">ক্যাশ লেজার</button>
                <button class="btn btn-sm btn-outline-primary w-100 rounded-pill" id="btn-b-gl" onclick="renderGL('bank')">ব্যাংক লেজার</button>
            </div>
            <div id="ledger-history"></div>
        </section>

        <!-- 6. PRODUCTS -->
        <section id="products" class="app-section">
            <div id="inventory-list-ui"></div>
        </section>

        <!-- 7. SETTINGS & PROFILE -->
        <section id="settings" class="app-section">
            <div class="card p-4 text-center">
                <i class="fa fa-user-circle fs-1 text-primary mb-3"></i>
                <h5 class="fw-bold m-0" id="user-display">User Name</h5>
                <p class="small text-muted">AGC POS Administrator</p>
                <hr>
                <button class="btn btn-danger w-100 rounded-pill" onclick="logout()">লগআউট</button>
            </div>
        </section>

    </div>

    <!-- Bottom Menu -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" onclick="switchSec('dashboard', this)"><i class="fa fa-th-large"></i>ড্যাশবোর্ড</a>
        <a href="#" class="nav-item" onclick="switchSec('pos', this)"><i class="fa fa-shopping-cart"></i>POS</a>
        <a href="#" class="nav-item" onclick="switchSec('sales', this)"><i class="fa fa-history"></i>বিক্রি</a>
        <a href="#" class="nav-item" onclick="switchSec('customers', this)"><i class="fa fa-users"></i>কাস্টমার</a>
        <a href="#" class="nav-item" onclick="switchSec('ledger', this)"><i class="fa fa-book"></i>লেজার</a>
    </nav>

    <script>
        // --- 1. FIREBASE CONFIGURATION (HOUSED FROM index1.html) ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBaWtBbFZS7NcZRsPZ4092kHeSfq2Jcm2o",
            authDomain: "datatechsolutionag.firebaseapp.com",
            projectId: "datatechsolutionag",
            storageBucket: "datatechsolutionag.firebasestorage.app",
            messagingSenderId: "53908668722",
            appId: "1:53908668722:web:fa287e03055dae1bfa172b",
            measurementId: "G-2JJBBZ99VQ"
        };

        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 2. Global Data States
        let products = [], customers = [], sales = [], ledgers = [], banks = [];
        let cart = [], currentInvoice = 10011;

        // 3. AUTH & AUTO-SYNC (Requirement 15, 17)
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                try {
                    await auth.signInAnonymously();
                } catch (e) {
                    alert("Database Connection Error!");
                }
            } else {
                document.getElementById('sync-indicator').innerHTML = '<i class="fa fa-check-circle"></i> Connected';
                startRealtimeListeners();
            }
        });

        function startRealtimeListeners() {
            // PRODUCTS
            db.collection('products').onSnapshot(s => {
                products = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderInventory();
                updateDashboardSummary();
            });

            // CUSTOMERS
            db.collection('customers').onSnapshot(s => {
                customers = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderCustomers();
                updateDashboardSummary();
            });

            // SALES
            db.collection('sales').onSnapshot(s => {
                sales = s.docs.map(d => ({id: d.id, ...d.data()}));
                updateDashboardSummary();
            });

            // LEDGERS & BANKS
            db.collection('ledgerEntries').onSnapshot(s => {
                ledgers = s.docs.map(d => ({id: d.id, ...d.data()}));
                updateDashboardSummary();
            });

            db.collection('banks').onSnapshot(s => {
                banks = s.docs.map(d => ({id: d.id, ...d.data()}));
                const bSel = document.getElementById('pos-bank-select');
                bSel.innerHTML = banks.map(b => `<option value="${b.id}">${b.bankName} (৳${b.currentBalance})</option>`).join('');
                updateDashboardSummary();
            });

            // INVOICE SETTINGS
            db.collection('settings').doc('invoice_config').onSnapshot(doc => {
                if(doc.exists) currentInvoice = doc.data().nextInvoice || 10011;
                else db.collection('settings').doc('invoice_config').set({nextInvoice: 10011});
                document.getElementById('loader').style.display = 'none';
            });
        }

        // --- 4. POS SYSTEM (Mobile Friendly) ---
        const posSearch = document.getElementById('pos-search');
        posSearch.oninput = function() {
            const v = this.value.toLowerCase();
            const sug = document.getElementById('pos-prod-sug');
            sug.innerHTML = '';
            if(!v) return sug.style.display = 'none';

            const matched = products.filter(p => p.name.toLowerCase().includes(v) || p.id.toLowerCase().includes(v));
            matched.forEach(p => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<div><b>${p.name}</b><br><small class="text-muted">স্টক: ${p.stock}</small></div><b>৳${p.price}</b>`;
                div.onclick = () => { addToCart(p); sug.style.display = 'none'; posSearch.value = ''; };
                sug.appendChild(div);
            });
            sug.style.display = matched.length ? 'block' : 'none';
        };

        function addToCart(p) {
            const ex = cart.find(i => i.id === p.id);
            if(ex) ex.qty++; else cart.push({...p, qty: 1});
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let total = 0;
            if(!cart.length) container.innerHTML = '<p class="text-center text-muted small my-4">কার্ট খালি আছে।</p>';
            cart.forEach((item, idx) => {
                total += (item.price * item.qty);
                container.innerHTML += `
                    <div class="cart-item">
                        <div><div class="fw-bold small">${item.name}</div><small class="text-primary">৳${item.price} x ${item.qty}</small></div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQty(${idx}, 1)">+</button>
                            <button class="qty-btn" onclick="updateQty(${idx}, -1)">-</button>
                            <i class="fa fa-trash-alt text-danger ms-2" onclick="cart.splice(${idx},1); renderCart()"></i>
                        </div>
                    </div>
                `;
            });
            document.getElementById('cart-grand-total').innerText = `৳ ${total.toLocaleString()}`;
        }

        function updateQty(idx, delta) {
            cart[idx].qty += delta;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
        }

        // Customer Search in POS
        const posCustName = document.getElementById('pos-cust-name');
        posCustName.oninput = function() {
            const v = this.value.toLowerCase();
            const sug = document.getElementById('pos-cust-sug');
            sug.innerHTML = '';
            if(!v) return sug.style.display = 'none';
            const matched = customers.filter(c => c.name.toLowerCase().includes(v) || c.phone.includes(v));
            matched.forEach(c => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = `${c.name} (${c.phone})`;
                div.onclick = () => {
                    posCustName.value = c.name;
                    document.getElementById('pos-cust-phone').value = c.phone;
                    document.getElementById('pos-cust-addr').value = c.address || '';
                    sug.style.display = 'none';
                };
                sug.appendChild(div);
            });
            sug.style.display = matched.length ? 'block' : 'none';
        };

        // --- 5. SALE PROCESSING (Full Accounting Re-calculation) ---
        async function completeSale() {
            if(!cart.length) return alert("কার্ট খালি!");
            const name = posCustName.value;
            const phone = document.getElementById('pos-cust-phone').value;
            if(!name || !phone) return alert("কাস্টমার তথ্য প্রদান করুন!");

            document.getElementById('loader').style.display = 'flex';
            const method = document.querySelector('input[name="payType"]:checked').value;
            const bankId = document.getElementById('pos-bank-select').value;
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const invId = currentInvoice.toString();
            const date = moment().format('YYYY-MM-DD');

            try {
                const batch = db.batch();
                
                // 1. Customer Handle
                let customerId;
                const existing = customers.find(c => c.phone === phone);
                if(existing) {
                    customerId = existing.id;
                    const upData = { totalPurchased: firebase.firestore.FieldValue.increment(total) };
                    if(method === 'due') upData.currentDue = firebase.firestore.FieldValue.increment(total);
                    else upData.totalPaid = firebase.firestore.FieldValue.increment(total);
                    batch.update(db.collection('customers').doc(customerId), upData);
                } else {
                    const newC = db.collection('customers').doc();
                    customerId = newC.id;
                    batch.set(newC, { id: customerId, name, phone, address: document.getElementById('pos-cust-addr').value, currentDue: method==='due'?total:0, totalPaid: method==='due'?0:total, totalPurchased: total });
                }

                // 2. Save Sale Record
                batch.set(db.collection('sales').doc(invId), {
                    saleId: invId, date, customerId, customerName: name, phone, finalAmount: total, paymentMethod: method, items: cart, timestamp: firebase.firestore.FieldValue.serverTimestamp(), bankId: method === 'bank' ? bankId : null
                });

                // 3. Stock Update
                cart.forEach(i => {
                    batch.update(db.collection('products').doc(i.id), { stock: firebase.firestore.FieldValue.increment(-i.qty) });
                });

                // 4. Ledger & Accounting
                if(method === 'cash') {
                    const lId = "L_" + Date.now();
                    batch.set(db.collection('ledgerEntries').doc(lId), { id: lId, date, type: 'income', category: 'sales_income', amount: total, saleId: invId, customerName: name });
                } else if(method === 'bank') {
                    const btId = "BT_" + Date.now();
                    batch.set(db.collection('bankTransactions').doc(btId), { id: btId, date, bankId, type: 'credit', amount: total, saleId: invId });
                    batch.update(db.collection('banks').doc(bankId), { currentBalance: firebase.firestore.FieldValue.increment(total) });
                }

                // 5. Update Global Settings
                batch.update(db.collection('settings').doc('invoice_config'), { nextInvoice: firebase.firestore.FieldValue.increment(1) });

                await batch.commit();
                alert("বিক্রয় সফল হয়েছে! ইনভয়েস: " + invId);
                cart = []; renderCart();
                posCustName.value = ''; document.getElementById('pos-cust-phone').value = '';
                showSec('dashboard', document.querySelector('.nav-item'));
            } catch(e) { alert("Error: " + e.message); }
            document.getElementById('loader').style.display = 'none';
        }

        // --- 6. BILL DELETE SYSTEM (The Critical Rollback - Requirement 6, 7) ---
        async function deleteBill(invId) {
            if(!confirm('আপনি কি নিশ্চিত? এটি ডিলিট করলে স্টক, কাস্টমার বকেয়া এবং লেজার অটোমেটিক রোলব্যাক হবে।')) return;
            document.getElementById('loader').style.display = 'flex';

            try {
                const saleRef = db.collection('sales').doc(invId);
                const doc = await saleRef.get();
                if(!doc.exists) return alert("বিল পাওয়া যায়নি!");
                const sale = doc.data();
                const batch = db.batch();

                // 1. Restore Stock
                sale.items.forEach(item => {
                    batch.update(db.collection('products').doc(item.id), { stock: firebase.firestore.FieldValue.increment(item.qty) });
                });

                // 2. Adjust Customer Account
                const custRef = db.collection('customers').doc(sale.customerId);
                if(sale.paymentMethod === 'due') {
                    batch.update(custRef, { currentDue: firebase.firestore.FieldValue.increment(-sale.finalAmount), totalPurchased: firebase.firestore.FieldValue.increment(-sale.finalAmount) });
                } else {
                    batch.update(custRef, { totalPaid: firebase.firestore.FieldValue.increment(-sale.finalAmount), totalPurchased: firebase.firestore.FieldValue.increment(-sale.finalAmount) });
                }

                // 3. Remove Cash/Bank Ledger
                if(sale.paymentMethod === 'cash') {
                    const lSnap = await db.collection('ledgerEntries').where('saleId', '==', invId).get();
                    lSnap.forEach(d => batch.delete(d.ref));
                } else if(sale.paymentMethod === 'bank') {
                    const bSnap = await db.collection('bankTransactions').where('saleId', '==', invId).get();
                    bSnap.forEach(d => {
                        batch.update(db.collection('banks').doc(d.data().bankId), { currentBalance: firebase.firestore.FieldValue.increment(-d.data().amount) });
                        batch.delete(d.ref);
                    });
                }

                // 4. Final Deletion
                batch.delete(saleRef);

                await batch.commit();
                alert("বিল ডিলিট এবং একাউন্টিং রোলব্যাক সম্পন্ন!");
                loadSalesReport();
            } catch(e) { alert("Delete failed: " + e.message); }
            document.getElementById('loader').style.display = 'none';
        }

        // --- 7. MANUAL DUE EDITING (Requirement 2) ---
        async function updateCustomerDueManually(id, current) {
            const newVal = prompt("নতুন বকেয়া পরিমাণ লিখুন (উদাহরণ: ৩০০০):", current);
            if(newVal !== null && newVal !== "") {
                document.getElementById('loader').style.display = 'flex';
                const newDue = parseFloat(newVal);
                const diff = newDue - current;

                try {
                    const batch = db.batch();
                    const custRef = db.collection('customers').doc(id);
                    batch.update(custRef, { currentDue: newDue });

                    // Log this adjustment in ledger for transparency
                    const adjId = "ADJ_" + Date.now();
                    batch.set(db.collection('ledgerEntries').doc(adjId), {
                        id: adjId, date: moment().format('YYYY-MM-DD'), type: diff > 0 ? 'expense' : 'income', 
                        category: 'manual_adjustment', amount: Math.abs(diff), description: `Manual Due Adjustment for Customer ID: ${id}`
                    });

                    await batch.commit();
                    alert("বকেয়া এবং লেজার অটো আপডেট হয়েছে!");
                    renderCustomers();
                } catch(e) { alert(e.message); }
                document.getElementById('loader').style.display = 'none';
            }
        }

        // --- 8. DASHBOARD & UI RENDERING ---
        function updateDashboardSummary() {
            const today = moment().format('YYYY-MM-DD');
            const todaySales = sales.filter(s => s.date === today).reduce((a, b) => a + (b.finalAmount || 0), 0);
            document.getElementById('dash-today-sale').innerText = `৳ ${todaySales.toLocaleString()}`;

            const totalDue = customers.reduce((a, b) => a + (b.currentDue || 0), 0);
            document.getElementById('dash-total-due').innerText = `৳ ${totalDue.toLocaleString()}`;

            let cashBal = 0; ledgers.forEach(l => cashBal += (l.type === 'income' ? l.amount : -l.amount));
            document.getElementById('dash-cash-bal').innerText = `৳ ${cashBal.toLocaleString()}`;

            let bankBal = 0; banks.forEach(b => bankBal += (b.currentBalance || 0));
            document.getElementById('dash-bank-bal').innerText = `৳ ${bankBal.toLocaleString()}`;

            // Low Stock Alert
            const lowProds = products.filter(p => p.stock <= (p.minStock || 5));
            const alertDiv = document.getElementById('low-stock-container');
            alertDiv.innerHTML = lowProds.length ? `<div class="alert alert-warning rounded-pill small p-2 text-center"><i class="fa fa-exclamation-triangle"></i> ${lowProds.length} টি প্রোডাক্টে স্টক কম আছে!</div>` : '';

            // 5. FORECAST LOGIC (Requirement 5)
            const forecastVal = todaySales * 30 * 0.85; // Simulated 3 months logic
            document.getElementById('forecast-sale').innerText = `৳ ${forecastVal.toLocaleString()}`;
        }

        function loadSalesReport() {
            const date = document.getElementById('sale-date').value || moment().format('YYYY-MM-DD');
            document.getElementById('sale-date').value = date;
            const container = document.getElementById('sales-report-list');
            container.innerHTML = '';
            
            const filtered = sales.filter(s => s.date === date);
            if(!filtered.length) container.innerHTML = '<div class="text-center p-5 text-muted small">আজ কোনো বিক্রি নেই।</div>';
            
            filtered.forEach(s => {
                container.innerHTML += `
                    <div class="list-row shadow-sm border-start border-4 border-primary">
                        <div class="small"><b>INV-${s.saleId}</b><br>${s.customerName}<br><span class="badge bg-light text-dark">${s.paymentMethod}</span></div>
                        <div class="text-end">
                            <h6 class="fw-bold m-0 text-primary">৳${s.finalAmount}</h6>
                            <button class="btn btn-sm text-danger border-0 p-0" onclick="deleteBill('${s.saleId}')"><i class="fa fa-trash-alt"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function renderCustomers(search = "") {
            const ui = document.getElementById('customer-list-ui');
            ui.innerHTML = '';
            const filtered = customers.filter(c => c.name.toLowerCase().includes(search.toLowerCase()) || c.phone.includes(search));
            
            filtered.forEach(c => {
                ui.innerHTML += `
                    <div class="card p-3 border-0 shadow-sm mb-2">
                        <div class="d-flex justify-content-between">
                            <b>${c.name}</b> <span class="text-danger fw-bold">৳ ${c.currentDue}</span>
                        </div>
                        <div class="small text-muted mb-2">${c.phone}</div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning w-100 rounded-pill" onclick="updateCustomerDueManually('${c.id}', ${c.currentDue})">Edit Due</button>
                            <button class="btn btn-sm btn-outline-primary w-100 rounded-pill" onclick="viewLedger('${c.id}')">Ledger</button>
                        </div>
                    </div>
                `;
            });
        }

        function renderInventory() {
            const ui = document.getElementById('inventory-list-ui');
            ui.innerHTML = products.map(p => `
                <div class="list-row">
                    <div class="small"><b>${p.name}</b><br><small class="text-muted">ID: ${p.id}</small></div>
                    <div class="text-end"><h6 class="m-0">৳${p.price}</h6><span class="badge ${p.stock < 5 ? 'bg-danger':'bg-success'}">Stock: ${p.stock}</span></div>
                </div>
            `).join('');
        }

        function handleBankSelect() {
            const method = document.querySelector('input[name="payType"]:checked').value;
            document.getElementById('bank-list-area').style.display = method === 'bank' ? 'block' : 'none';
        }

        function switchSec(id, el) {
            document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            if(id === 'sales') loadSalesReport();
            if(id === 'customers') renderCustomers();
            if(id === 'ledger') renderGL('cash');
        }

        function renderGL(type) {
            document.getElementById('btn-c-gl').classList.toggle('active', type === 'cash');
            document.getElementById('btn-b-gl').classList.toggle('active', type === 'bank');
            const ui = document.getElementById('ledger-history');
            ui.innerHTML = '';
            
            // Simplified rendering for GL logic
            const entries = type === 'cash' ? ledgers : []; // Add bank tx here
            ui.innerHTML = entries.length ? entries.map(e => `
                <div class="list-row small">
                    <div><b>${e.date}</b><br>${e.description || 'Sale Income'}</div>
                    <b class="${e.type === 'income' ? 'text-success' : 'text-danger'}">${e.type === 'income' ? '+':'-'}৳${e.amount}</b>
                </div>
            `).join('') : '<div class="text-center p-5 text-muted">কোনো ট্রানজ্যাকশন নেই।</div>';
        }

        window.onload = initApp;

    </script>
</body>
</html>
